name: CI Clinica 

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]

permissions:
  contents: read

env:
  COMPOSER_NO_INTERACTION: 1
  COMPOSER_PROCESS_TIMEOUT: 0
  COMPOSER_NO_AUDIT: 1

jobs:
  # ===========================================================
  # JOB 1: CI — Validación profesional del proyecto PHP
  # ===========================================================
  ci:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, pdo, pdo_mysql
        tools: phpunit
        coverage: none

    - name: Validate composer.json
      run: |
        if [ -f composer.json ]; then
          composer validate --strict
        else
          echo "No composer.json found — skipping validate"
        fi

    - name: Cache Composer files
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install Dependencies
      run: |
        if [ -f composer.json ]; then
          composer install --prefer-dist --no-interaction --no-progress
        else
          echo "No composer.json - skipping composer install"
        fi

    # ---------- Install tools ----------
    - name: Install PHPStan
      run: |
        wget -q https://github.com/phpstan/phpstan/releases/latest/download/phpstan.phar -O phpstan
        chmod +x phpstan

    - name: Install PHPCS
      run: |
        composer global require squizlabs/php_codesniffer
        echo "${HOME}/.composer/vendor/bin" >> $GITHUB_PATH

    - name: Install PHPMD
      run: |
        composer global require phpmd/phpmd
        echo "${HOME}/.composer/vendor/bin" >> $GITHUB_PATH

    - name: Install PHPCPD
      run: |
        wget -q https://phar.phpunit.de/phpcpd.phar -O phpcpd
        chmod +x phpcpd

    # ---------- Code Analysis ----------
    - name: PHPCS (PSR-12)
      run: phpcs --standard=PSR12 . || true

    - name: PHPStan (level max)
      run: ./phpstan analyse . --level=max --no-progress || true

    - name: PHPMD
      run: phpmd . text cleancode,codesize,design,unusedcode || true

    - name: PHPCPD
      run: ./phpcpd . || true

    - name: Run PHPUnit
      run: |
        if [ -f vendor/bin/phpunit ]; then
          vendor/bin/phpunit || true
        else
          echo "PHPUnit no encontrado — no hay tests aún"
        fi


  # ===========================================================
  # JOB 2: Docker — Build & Push (solo si CI pasa)
  # ===========================================================
  docker:
    needs: ci          # solo ejecuta si CI fue exitoso
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build & Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ vars.DOCKERHUB_USERNAME }}/clinica:latest
          ${{ vars.DOCKERHUB_USERNAME }}/clinica:${{ github.run_number }}
